<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falciforme+ | Portal do Profissional</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .screen { padding: 40px 30px; }
        .hidden { display: none !important; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #0ea5e9; font-size: 28px; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); color: white; }
        .btn-secondary { background: white; color: #0ea5e9; border: 2px solid #0ea5e9; }
        .error { background: #fee; color: #c33; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 10px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .column {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
        }
        .column-title {
            font-size: 20px;
            font-weight: 700;
            color: #0ea5e9;
            margin-bottom: 15px;
        }
        .patient-card {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .patient-card:hover { border-color: #0ea5e9; }
        .patient-name { font-size: 18px; font-weight: 600; color: #0ea5e9; margin-bottom: 8px; }
        .alert-card {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .alert-card:hover { border-color: #0ea5e9; }
        .alert-card.alert {
            background: #fef2f2;
            border-color: #fecaca;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
        }
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .tabs {
            background: #f9fafb;
            padding: 15px 20px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .tab-btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }
        .tab-btn:hover { border-color: #0ea5e9; color: #0ea5e9; }
        .tab-btn.active {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        .modal-body { padding: 30px; }
        .info-card {
            background: #f8f9ff;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .info-row {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-row:last-child { border-bottom: none; }
        .section-title {
            color: #0ea5e9;
            font-size: 18px;
            font-weight: 700;
            margin: 25px 0 15px 0;
        }
        .data-card {
            background: #f8f9ff;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .data-card.alert { background: #fef2f2; border-color: #fecaca; }
        .data-card.success { background: #d4edda; border-color: #c3e6cb; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #0ea5e9;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .chart-label {
            width: 140px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        .chart-fill {
            flex: 1;
            height: 35px;
            background: linear-gradient(90deg, #0ea5e9 0%, #3b82f6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 15px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0ea5e9;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e0e0e0;
        }
        .empty { text-align: center; padding: 60px 20px; color: #999; }

        /* Media queries para responsividade */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 10px;
            }

            .screen {
                padding: 20px 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header > div:last-child {
                align-self: flex-end;
            }

            .main-grid {
                padding: 10px;
                gap: 15px;
            }

            .column {
                padding: 15px;
            }

            .column-title {
                font-size: 18px;
            }

            .patient-card {
                padding: 12px;
            }

            .patient-name {
                font-size: 16px;
            }

            .modal-content {
                max-width: 100%;
                margin: 10px;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                font-size: 14px;
                padding: 10px 18px;
            }

            .modal-body {
                padding: 20px 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .stat-value {
                font-size: 28px;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 24px;
            }

            .column-title {
                font-size: 16px;
            }

            .patient-name {
                font-size: 15px;
            }

            .alert-card, .patient-card {
                font-size: 14px;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .close-btn {
                padding: 8px 15px;
                font-size: 14px;
            }

            .tab-btn {
                font-size: 13px;
                padding: 8px 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Landscape mode para tablets */
        @media (max-width: 1024px) and (orientation: landscape) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }

            body {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login -->
        <div class="screen" id="loginScreen">
            <div class="logo">
                <h1>ü©∏ Falciforme+</h1>
                <p>Portal do Profissional</p>
            </div>
            <div class="error" id="loginError"></div>
            <form onsubmit="return doLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required value="medico@hospital.pt">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required value="medico123">
                </div>
                <button type="submit" class="btn btn-primary">Entrar</button>
                <button type="button" class="btn btn-secondary" onclick="goToRegister()">Criar Conta</button>
            </form>
        </div>

        <!-- Register -->
        <div class="screen hidden" id="registerScreen">
            <div class="logo">
                <h1>ü©∏ Falciforme+</h1>
                <p>Criar Conta Profissional</p>
            </div>
            <div class="error" id="registerError"></div>
            <form onsubmit="return doRegister(event)">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="regName" required>
                </div>
                <div class="form-group">
                    <label>Especialidade</label>
                    <select id="regSpecialty" required>
                        <option value="">Selecione...</option>
                        <option value="Hematologia">Hematologia</option>
                        <option value="Medicina Interna">Medicina Interna</option>
                        <option value="Pediatria">Pediatria</option>
                        <option value="Enfermagem">Enfermagem</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>N¬∫ C√©dula</label>
                    <input type="text" id="regLicense" required>
                </div>
                <div class="form-group">
                    <label>Institui√ß√£o</label>
                    <input type="text" id="regInstitution" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6)</label>
                    <input type="password" id="regPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Password</label>
                    <input type="password" id="regPasswordConfirm" required>
                </div>
                <button type="submit" class="btn btn-primary">Registar</button>
                <button type="button" class="btn btn-secondary" onclick="goToLogin()">Voltar</button>
            </form>
        </div>

        <!-- App -->
        <div id="appScreen" class="hidden">
            <div class="header">
                <div>
                    <h2 id="userName">Dr.</h2>
                    <p><span id="userInfo"></span></p>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;" id="lastUpdate">Atualizado agora</p>
                    <button class="logout-btn" onclick="doLogout()">Sair</button>
                </div>
            </div>
            <div class="main-grid">
                <div class="column">
                    <div class="column-title">üë• Doentes (<span id="patientCount">0</span>)</div>
                    <div id="patientList"></div>
                </div>
                <div class="column">
                    <div class="column-title">‚ö†Ô∏è Alertas (24h)</div>
                    <div id="alertList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Doente -->
    <div class="modal" id="patientModal" onclick="if(event.target===this) closePatient()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="patientName">Doente</h2>
                <button class="close-btn" onclick="closePatient()">‚úï Fechar</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('resumo', event)">üìä Resumo</button>
                <button class="tab-btn" onclick="switchTab('perfil', event)">üë§ Perfil</button>
                <button class="tab-btn" onclick="switchTab('sintomas', event)">ü©π Sintomas</button>
                <button class="tab-btn" onclick="switchTab('medicacao', event)">üíä Medica√ß√£o</button>
                <button class="tab-btn" onclick="switchTab('historico', event)">üìÖ Hist√≥rico</button>
                <button class="tab-btn" onclick="switchTab('analises', event)">üß™ An√°lises</button>
            </div>
            <div class="modal-body" id="patientContent"></div>
        </div>
    </div>

    <script>
        let profs = JSON.parse(localStorage.getItem('professionals') || '[]');
        if (profs.length === 0) {
            profs = [{
                name: 'Dr. Jo√£o Santos',
                specialty: 'Hematologia',
                institution: 'Hospital Central',
                email: 'medico@hospital.pt',
                password: 'medico123'
            }];
            localStorage.setItem('professionals', JSON.stringify(profs));
        }
        
        let currentUser = null;
        let currentPatientIdx = -1;
        let autoRefreshInterval = null;

        function goToRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function goToLogin() {
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function doLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const user = profs.find(p => p.email === email && p.password === password);
            
            if (user) {
                currentUser = user;
                showApp();
            } else {
                const err = document.getElementById('loginError');
                err.textContent = 'Email ou password incorretos';
                err.style.display = 'block';
            }
            return false;
        }

        function doRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const specialty = document.getElementById('regSpecialty').value;
            const license = document.getElementById('regLicense').value.trim();
            const institution = document.getElementById('regInstitution').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            
            const err = document.getElementById('registerError');
            
            if (!name || !specialty || !license || !institution || !email || !password) {
                err.textContent = 'Preencha todos os campos';
                err.style.display = 'block';
                return false;
            }
            
            if (password !== passwordConfirm) {
                err.textContent = 'Passwords n√£o coincidem';
                err.style.display = 'block';
                return false;
            }
            
            if (profs.find(p => p.email === email)) {
                err.textContent = 'Email j√° existe';
                err.style.display = 'block';
                return false;
            }
            
            const newUser = { name, specialty, license, institution, email, password };
            profs.push(newUser);
            localStorage.setItem('professionals', JSON.stringify(profs));
            
            alert('‚úì Conta criada!');
            currentUser = newUser;
            showApp();
            return false;
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userInfo').textContent = currentUser.specialty + ' - ' + currentUser.institution;
            
            loadPatients();
            
            // Atualiza√ß√£o autom√°tica a cada 10 segundos
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Atualiza√ß√£o autom√°tica...');
                loadPatients();
            }, 10000); // 10 segundos
        }

        function loadPatients() {
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            document.getElementById('patientCount').textContent = patients.length;
            
            // Atualizar timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            document.getElementById('lastUpdate').textContent = 'Atualizado √†s ' + timeStr;
            
            const listEl = document.getElementById('patientList');
            const alertEl = document.getElementById('alertList');
            
            if (patients.length === 0) {
                listEl.innerHTML = '<div class="empty"><p>Nenhum doente registado</p></div>';
                alertEl.innerHTML = '<div class="empty"><p>Sem alertas</p></div>';
                return;
            }
            
            // Lista de doentes
            let html = '';
            const alerts = generateAlerts(patients);
            
            patients.forEach((p, i) => {
                const age = calcAge(p.birthDate);
                
                // Verificar se tem alertas
                const patientAlerts = alerts.filter(a => a.patientIdx === i);
                const hasHighPriority = patientAlerts.some(a => a.priority === 'high');
                const hasMediumPriority = patientAlerts.some(a => a.priority === 'medium');
                
                let statusIcon = 'üü¢'; // Verde por defeito
                let statusColor = '#059669';
                
                if (hasHighPriority) {
                    statusIcon = 'üî¥';
                    statusColor = '#dc2626';
                } else if (hasMediumPriority) {
                    statusIcon = 'üü°';
                    statusColor = '#d97706';
                }
                
                html += '<div class="patient-card" onclick="openPatient(' + i + ')">';
                html += '<div style="display: flex; align-items: center; gap: 10px;">';
                html += '<div style="font-size: 20px;">' + statusIcon + '</div>';
                html += '<div style="flex: 1;">';
                html += '<div class="patient-name">' + (p.name || 'Sem nome') + '</div>';
                html += '<p style="font-size: 14px; color: #666;">';
                html += age + ' anos ‚Ä¢ ' + (p.gender === 'M' ? 'Masculino' : 'Feminino') + '<br>';
                html += 'üìß ' + p.email;
                if (p.phone) html += '<br>üìû ' + p.phone;
                html += '</p></div></div></div>';
            });
            listEl.innerHTML = html;
            
            // Gerar alertas organizados
            if (alerts.length === 0) {
                alertEl.innerHTML = '<div class="empty"><p>‚úì Sem alertas</p></div>';
            } else {
                // Separar por prioridade
                const highPriority = alerts.filter(a => a.priority === 'high');
                const mediumPriority = alerts.filter(a => a.priority === 'medium');
                
                // Ordenar cada grupo por data (mais recente primeiro)
                highPriority.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                mediumPriority.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                let alertHtml = '';
                
                // Alertas vermelhos (alta prioridade)
                if (highPriority.length > 0) {
                    alertHtml += '<div style="background: #fee; border: 2px solid #fcc; border-radius: 12px; padding: 15px; margin-bottom: 15px;">';
                    alertHtml += '<h4 style="color: #dc2626; margin-bottom: 10px; font-size: 16px;">üî¥ Alertas Muito Urgentes (' + highPriority.length + ')</h4>';
                    
                    highPriority.forEach(alert => {
                        alertHtml += '<div class="alert-card alert" onclick="openPatient(' + alert.patientIdx + ')" style="margin-bottom: 8px;">';
                        alertHtml += '<div style="font-weight: 600; color: #dc2626; margin-bottom: 5px;">';
                        alertHtml += alert.icon + ' ' + alert.title + '</div>';
                        alertHtml += '<div style="font-size: 14px; color: #666;">';
                        alertHtml += '<strong>' + alert.patientName + '</strong><br>';
                        alertHtml += alert.description + '</div>';
                        alertHtml += '</div>';
                    });
                    
                    alertHtml += '</div>';
                }
                
                // Alertas amarelos (m√©dia prioridade)
                if (mediumPriority.length > 0) {
                    alertHtml += '<div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 12px; padding: 15px;">';
                    alertHtml += '<h4 style="color: #d97706; margin-bottom: 10px; font-size: 16px;">üü° Alertas Urgentes (' + mediumPriority.length + ')</h4>';
                    
                    mediumPriority.forEach(alert => {
                        alertHtml += '<div class="alert-card" onclick="openPatient(' + alert.patientIdx + ')" style="margin-bottom: 8px; background: white;">';
                        alertHtml += '<div style="font-weight: 600; color: #d97706; margin-bottom: 5px;">';
                        alertHtml += alert.icon + ' ' + alert.title + '</div>';
                        alertHtml += '<div style="font-size: 14px; color: #666;">';
                        alertHtml += '<strong>' + alert.patientName + '</strong><br>';
                        alertHtml += alert.description + '</div>';
                        alertHtml += '</div>';
                    });
                    
                    alertHtml += '</div>';
                }
                
                alertEl.innerHTML = alertHtml;
            }
        }
        
        function generateAlerts(patients) {
            const alerts = [];
            const now = Date.now();
            
            patients.forEach((p, idx) => {
                const cd = p.clinicalData || { symptoms: [], medications: [], sosMeds: {} };
                
                // 1. Dor com intensidade > 7
                const painAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'dor') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    return hoursAgo <= 48 && s.intensity > 7;
                });
                
                if (painAlerts.length > 0) {
                    const lastPain = painAlerts[painAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastPain.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: 'üö®',
                        title: 'Dor Intensa',
                        description: 'Dor n√≠vel ' + lastPain.intensity + '/10 h√° ' + hoursAgo + 'h' + (lastPain.location ? ' - ' + lastPain.location : ''),
                        timestamp: new Date(lastPain.date).getTime()
                    });
                }
                
                // 1b. Dor moderada (4-6)
                const moderatePainAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'dor') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    return hoursAgo <= 48 && s.intensity >= 4 && s.intensity <= 6;
                });
                
                if (moderatePainAlerts.length > 0) {
                    const lastPain = moderatePainAlerts[moderatePainAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastPain.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'medium',
                        icon: '‚ö†Ô∏è',
                        title: 'Dor Moderada',
                        description: 'Dor n√≠vel ' + lastPain.intensity + '/10 h√° ' + hoursAgo + 'h' + (lastPain.location ? ' - ' + lastPain.location : ''),
                        timestamp: new Date(lastPain.date).getTime()
                    });
                }
                
                // 2. Dor h√° mais de 48h
                const oldPain = cd.symptoms.filter(s => {
                    if (s.type !== 'dor') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    return hoursAgo > 48 && hoursAgo <= 72;
                });
                
                if (oldPain.length > 0) {
                    const firstPain = oldPain[0];
                    const hoursAgo = Math.floor((now - new Date(firstPain.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: '‚ö†Ô∏è',
                        title: 'Dor Prolongada',
                        description: 'Dor h√° mais de ' + Math.floor(hoursAgo/24) + ' dias',
                        timestamp: new Date(firstPain.date).getTime()
                    });
                }
                
                // 2b. Dor em 2 dias seguidos
                const allPain = cd.symptoms.filter(s => s.type === 'dor');
                if (allPain.length >= 2) {
                    // Agrupar por dia
                    const painByDay = {};
                    allPain.forEach(s => {
                        const date = new Date(s.date);
                        const dayKey = date.toDateString();
                        if (!painByDay[dayKey]) painByDay[dayKey] = [];
                        painByDay[dayKey].push(s);
                    });
                    
                    // Verificar dias consecutivos nos √∫ltimos 7 dias
                    const days = Object.keys(painByDay).sort((a, b) => new Date(b) - new Date(a));
                    for (let i = 0; i < days.length - 1; i++) {
                        const day1 = new Date(days[i]);
                        const day2 = new Date(days[i + 1]);
                        const diffDays = Math.floor((day1 - day2) / (1000*60*60*24));
                        const daysAgo = Math.floor((now - day1.getTime()) / (1000*60*60*24));
                        
                        if (diffDays === 1 && daysAgo <= 7) {
                            alerts.push({
                                patientIdx: idx,
                                patientName: p.name,
                                priority: 'medium',
                                icon: 'üìÖ',
                                title: 'Dor em Dias Consecutivos',
                                description: 'Dor registada em 2 dias seguidos',
                                timestamp: day1.getTime()
                            });
                            break; // S√≥ um alerta mesmo que haja m√∫ltiplos pares
                        }
                    }
                }
                
                // 3. Febre
                const feverAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'febre') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    return hoursAgo <= 48;
                });
                
                if (feverAlerts.length > 0) {
                    const lastFever = feverAlerts[feverAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastFever.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: 'üå°Ô∏è',
                        title: 'Febre',
                        description: (lastFever.temperature || '?') + '¬∞C h√° ' + hoursAgo + 'h',
                        timestamp: new Date(lastFever.date).getTime()
                    });
                }
                
                // 4. Cansa√ßo forte ou extremo
                const fatigueAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'cansaco') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    if (hoursAgo > 48) return false;
                    
                    const level = (s.level || '').toLowerCase();
                    // Aceita: "Forte", "Extremo", ou qualquer string que contenha essas palavras
                    return level.includes('forte') || level.includes('extremo');
                });
                
                if (fatigueAlerts.length > 0) {
                    const lastFatigue = fatigueAlerts[fatigueAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastFatigue.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: 'üò¥',
                        title: 'Cansa√ßo Intenso',
                        description: lastFatigue.level + ' h√° ' + hoursAgo + 'h',
                        timestamp: new Date(lastFatigue.date).getTime()
                    });
                }
                
                // 4b. Cansa√ßo moderado
                const moderateFatigueAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'cansaco') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    if (hoursAgo > 48) return false;
                    
                    const level = (s.level || '').toLowerCase();
                    return level.includes('moderado');
                });
                
                if (moderateFatigueAlerts.length > 0) {
                    const lastFatigue = moderateFatigueAlerts[moderateFatigueAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastFatigue.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'medium',
                        icon: 'üò¥',
                        title: 'Cansa√ßo Moderado',
                        description: lastFatigue.level + ' h√° ' + hoursAgo + 'h',
                        timestamp: new Date(lastFatigue.date).getTime()
                    });
                }
                
                // 5. Dificuldade respirat√≥ria forte ou muito forte
                const breathingAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'respiracao') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    const difficulty = (s.difficulty || '').toLowerCase();
                    return hoursAgo <= 48 && (difficulty.includes('forte') || difficulty.includes('muito') || difficulty.includes('severa'));
                });
                
                if (breathingAlerts.length > 0) {
                    const lastBreathing = breathingAlerts[breathingAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastBreathing.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: 'ü´Å',
                        title: 'Dificuldade Respirat√≥ria',
                        description: lastBreathing.difficulty + ' h√° ' + hoursAgo + 'h',
                        timestamp: new Date(lastBreathing.date).getTime()
                    });
                }
                
                // 5b. Dificuldade respirat√≥ria moderada
                const moderateBreathingAlerts = cd.symptoms.filter(s => {
                    if (s.type !== 'respiracao') return false;
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    const difficulty = (s.difficulty || '').toLowerCase();
                    return hoursAgo <= 48 && difficulty.includes('moderada');
                });
                
                if (moderateBreathingAlerts.length > 0) {
                    const lastBreathing = moderateBreathingAlerts[moderateBreathingAlerts.length - 1];
                    const hoursAgo = Math.floor((now - new Date(lastBreathing.date).getTime()) / (1000*60*60));
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'medium',
                        icon: 'ü´Å',
                        title: 'Dificuldade Respirat√≥ria Moderada',
                        description: lastBreathing.difficulty + ' h√° ' + hoursAgo + 'h',
                        timestamp: new Date(lastBreathing.date).getTime()
                    });
                }
                
                // 6. Toma de analg√©sicos h√° mais de 48h
                const allSOS = [];
                Object.keys(cd.sosMeds || {}).forEach(type => {
                    if (cd.sosMeds[type]) {
                        cd.sosMeds[type].forEach(dose => {
                            allSOS.push({ type, date: dose.date });
                        });
                    }
                });
                
                if (allSOS.length > 0) {
                    allSOS.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const lastSOS = allSOS[0];
                    const hoursAgo = (now - new Date(lastSOS.date).getTime()) / (1000*60*60);
                    
                    if (hoursAgo > 48 && hoursAgo <= 72) {
                        alerts.push({
                            patientIdx: idx,
                            patientName: p.name,
                            priority: 'medium',
                            icon: 'üíä',
                            title: 'Analg√©sicos Prolongados',
                            description: '√öltima toma h√° ' + Math.floor(hoursAgo/24) + ' dias',
                            timestamp: new Date(lastSOS.date).getTime()
                        });
                    }
                }
                
                // 7. Mais de 3 analg√©sicos num dia
                const sosToday = allSOS.filter(s => {
                    const hoursAgo = (now - new Date(s.date).getTime()) / (1000*60*60);
                    return hoursAgo <= 24;
                });
                
                if (sosToday.length > 3) {
                    const lastSOS = sosToday[sosToday.length - 1];
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'high',
                        icon: 'üíä',
                        title: 'Uso Excessivo Analg√©sicos',
                        description: sosToday.length + ' tomas nas √∫ltimas 24h',
                        timestamp: new Date(lastSOS.date).getTime()
                    });
                }
                
                // 8. Sem medica√ß√£o registada h√° 7 dias
                const meds7days = cd.medications.filter(m => {
                    const daysAgo = (now - new Date(m.date).getTime()) / (1000*60*60*24);
                    return daysAgo <= 7;
                });
                
                // Verificar se o doente tem mais de 7 dias desde registo
                const daysSinceRegistration = (now - new Date(p.registrationDate).getTime()) / (1000*60*60*24);
                
                if (daysSinceRegistration > 7 && meds7days.length === 0) {
                    alerts.push({
                        patientIdx: idx,
                        patientName: p.name,
                        priority: 'medium',
                        icon: '‚è∞',
                        title: 'Sem Registo de Medica√ß√£o',
                        description: 'Nenhuma medica√ß√£o registada nos √∫ltimos 7 dias',
                        timestamp: now - (7 * 24 * 60 * 60 * 1000)
                    });
                }
                
                // 9. Hemoglobina inferior a 6g/dL
                if (cd.labResults && cd.labResults.length > 0) {
                    const recentLabs = cd.labResults.filter(lab => {
                        const daysAgo = (now - new Date(lab.date).getTime()) / (1000*60*60*24);
                        return daysAgo <= 30;
                    });
                    
                    recentLabs.forEach(lab => {
                        if (lab.hemoglobin && lab.hemoglobin < 6) {
                            const daysAgo = Math.floor((now - new Date(lab.date).getTime()) / (1000*60*60*24));
                            alerts.push({
                                patientIdx: idx,
                                patientName: p.name,
                                priority: 'high',
                                icon: 'ü©∏',
                                title: 'Hemoglobina Cr√≠tica',
                                description: 'Hb: ' + lab.hemoglobin + ' g/dL (h√° ' + daysAgo + ' dias)',
                                timestamp: new Date(lab.date).getTime()
                            });
                        }
                    });
                }
            });
            
            // Ordenar por prioridade (high primeiro)
            alerts.sort((a, b) => {
                if (a.priority === 'high' && b.priority !== 'high') return -1;
                if (a.priority !== 'high' && b.priority === 'high') return 1;
                return 0;
            });
            
            return alerts;
        }

        function calcAge(birthDate) {
            if (!birthDate) return '?';
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function openPatient(idx) {
            currentPatientIdx = idx;
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            const p = patients[idx];
            
            document.getElementById('patientName').textContent = p.name;
            switchTab('resumo');
        }

        function switchTab(tab, event) {
            if (event) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
            }
            
            const patients = JSON.parse(localStorage.getItem('patients') || '[]');
            const p = patients[currentPatientIdx];
            const cd = p.clinicalData || { symptoms: [], medications: [], sosMeds: {} };
            
            let html = '';
            
            if (tab === 'resumo') {
                const symptoms7 = cd.symptoms.filter(s => (Date.now() - new Date(s.date).getTime()) / (1000*60*60*24) <= 7);
                const meds7 = cd.medications.filter(m => (Date.now() - new Date(m.date).getTime()) / (1000*60*60*24) <= 7);
                const takenMeds = meds7.filter(m => m.taken).length;
                const adherence = meds7.length > 0 ? Math.round((takenMeds / meds7.length) * 100) : 0;
                const crises = symptoms7.filter(s => s.type === 'dor' && s.intensity >= 6).length;
                
                html += '<div class="section-title">üìã Informa√ß√£o</div>';
                html += '<div class="info-card">';
                html += '<div class="info-row"><strong>Nome:</strong> ' + p.name + '</div>';
                html += '<div class="info-row"><strong>Idade:</strong> ' + calcAge(p.birthDate) + ' anos</div>';
                html += '<div class="info-row"><strong>G√©nero:</strong> ' + (p.gender === 'M' ? 'Masculino' : 'Feminino') + '</div>';
                html += '<div class="info-row"><strong>Email:</strong> ' + p.email + '</div>';
                if (p.phone) html += '<div class="info-row"><strong>Telefone:</strong> ' + p.phone + '</div>';
                html += '</div>';
                
                html += '<div class="section-title">üìä Estat√≠sticas (7 dias)</div>';
                html += '<div class="stats-grid">';
                html += '<div class="stat-card"><div class="stat-value">' + crises + '</div><div class="stat-label">Crises</div></div>';
                html += '<div class="stat-card"><div class="stat-value">' + adherence + '%</div><div class="stat-label">Ades√£o</div></div>';
                html += '<div class="stat-card"><div class="stat-value">' + symptoms7.length + '</div><div class="stat-label">Sintomas</div></div>';
                html += '</div>';
                
                if (cd.symptoms.length === 0) {
                    html += '<div class="data-card" style="background: #fffbeb; border-color: #fde68a;"><p style="color: #92400e;">O doente ainda n√£o registou dados cl√≠nicos.</p></div>';
                }
            } else if (tab === 'sintomas') {
                const symptoms = cd.symptoms.slice().reverse();
                
                if (symptoms.length === 0) {
                    html += '<div class="empty"><p>Sem sintomas registados</p></div>';
                } else {
                    html += '<div class="section-title">ü©π Sintomas (' + symptoms.length + ')</div>';
                    html += '<div class="timeline">';
                    
                    symptoms.slice(0, 10).forEach(s => {
                        const date = new Date(s.date);
                        const timeStr = date.toLocaleString('pt-PT', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'});
                        const types = {dor: 'Dor', febre: 'Febre', cansaco: 'Cansa√ßo', respiracao: 'Respira√ß√£o'};
                        
                        html += '<div class="timeline-item"><div class="data-card ' + (s.type === 'dor' && s.intensity >= 7 ? 'alert' : '') + '">';
                        html += '<h4 style="margin-bottom: 8px;">' + (types[s.type] || s.type) + '</h4>';
                        html += '<p style="font-size: 14px;"><strong>Data:</strong> ' + timeStr + '<br>';
                        
                        if (s.type === 'dor') {
                            html += '<strong>Intensidade:</strong> ' + s.intensity + '/10<br>';
                            html += '<strong>Local:</strong> ' + (s.location || 'N/A');
                        } else if (s.type === 'febre') {
                            html += '<strong>Temperatura:</strong> ' + s.temperature + '¬∞C';
                        } else if (s.type === 'cansaco') {
                            html += '<strong>N√≠vel:</strong> ' + (s.level || 'N/A');
                        }
                        
                        html += '</p></div></div>';
                    });
                    
                    html += '</div>';
                }
            } else if (tab === 'medicacao') {
                const meds = cd.medications.slice().reverse();
                const meds7 = meds.filter(m => (Date.now() - new Date(m.date).getTime()) / (1000*60*60*24) <= 7);
                const takenCount = meds7.filter(m => m.taken).length;
                const adherence = meds7.length > 0 ? Math.round((takenCount / meds7.length) * 100) : 0;
                
                if (meds.length === 0) {
                    html += '<div class="empty"><p>Sem medica√ß√£o registada</p></div>';
                } else {
                    html += '<div class="section-title">üíä Ades√£o (7 dias)</div>';
                    if (meds7.length > 0) {
                        html += '<div class="chart-bar"><div class="chart-label">Total</div>';
                        html += '<div class="chart-fill" style="width: ' + adherence + '%;">' + takenCount + '/' + meds7.length + ' (' + adherence + '%)</div></div>';
                    }
                    
                    html += '<div class="section-title">üìã √öltimas Tomas (10)</div>';
                    
                    meds.slice(0, 10).forEach(m => {
                        const date = new Date(m.date);
                        const timeStr = date.toLocaleString('pt-PT', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'});
                        
                        html += '<div class="data-card ' + (m.taken ? 'success' : 'alert') + '">';
                        html += '<p style="font-size: 14px;"><strong>' + m.medication + '</strong><br>';
                        html += timeStr + '<br>';
                        html += '<strong>Status:</strong> ' + (m.taken ? '‚úì Tomado' : '‚úó N√£o tomado');
                        if (m.taken && m.time) html += ' √†s ' + m.time;
                        html += '</p></div>';
                    });
                }
            } else if (tab === 'historico') {
                const appointments = cd.appointments || [];
                const emergencies = cd.emergencies || [];
                
                html += '<div class="section-title">üìÖ Consultas</div>';
                
                if (appointments.length === 0) {
                    html += '<div class="data-card"><p style="color: #666;">Sem consultas registadas</p></div>';
                } else {
                    appointments.slice().reverse().forEach(apt => {
                        const date = new Date(apt.date);
                        const dateStr = date.toLocaleDateString('pt-PT');
                        
                        html += '<div class="data-card">';
                        html += '<h4 style="color: #0ea5e9; margin-bottom: 10px;">' + (apt.type || 'Consulta') + '</h4>';
                        html += '<p style="font-size: 14px; line-height: 1.8;">';
                        html += '<strong>Data:</strong> ' + dateStr + '<br>';
                        if (apt.doctor) html += '<strong>M√©dico:</strong> ' + apt.doctor + '<br>';
                        if (apt.notes) html += '<strong>Notas:</strong> ' + apt.notes + '<br>';
                        if (apt.nextAppointment) {
                            const nextDate = new Date(apt.nextAppointment);
                            html += '<strong>Pr√≥xima consulta:</strong> ' + nextDate.toLocaleDateString('pt-PT');
                        }
                        html += '</p></div>';
                    });
                }
                
                html += '<div class="section-title">üö® Urg√™ncias</div>';
                
                if (emergencies.length === 0) {
                    html += '<div class="data-card"><p style="color: #666;">Sem urg√™ncias registadas</p></div>';
                } else {
                    html += '<div class="timeline">';
                    emergencies.slice().reverse().forEach(emg => {
                        const date = new Date(emg.date);
                        const dateStr = date.toLocaleString('pt-PT', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                        
                        html += '<div class="timeline-item">';
                        html += '<div class="data-card ' + (emg.severity === 'high' ? 'alert' : '') + '">';
                        html += '<h4 style="color: ' + (emg.severity === 'high' ? '#dc2626' : '#d97706') + '; margin-bottom: 8px;">';
                        html += (emg.reason || 'Urg√™ncia') + '</h4>';
                        html += '<p style="font-size: 14px; line-height: 1.6;">';
                        html += '<strong>Data:</strong> ' + dateStr + '<br>';
                        if (emg.diagnosis) html += '<strong>Diagn√≥stico:</strong> ' + emg.diagnosis + '<br>';
                        if (emg.treatment) html += '<strong>Tratamento:</strong> ' + emg.treatment + '<br>';
                        if (emg.duration) html += '<strong>Dura√ß√£o:</strong> ' + emg.duration + '<br>';
                        if (emg.outcome) html += '<strong>Resultado:</strong> ' + emg.outcome;
                        html += '</p></div></div>';
                    });
                    html += '</div>';
                }
                
                if (emergencies.length > 0) {
                    const last3Months = emergencies.filter(e => {
                        const daysAgo = (Date.now() - new Date(e.date).getTime()) / (1000*60*60*24);
                        return daysAgo <= 90;
                    });
                    
                    html += '<div class="data-card ' + (last3Months.length > 2 ? 'alert' : 'success') + '" style="margin-top: 20px;">';
                    html += '<p style="font-size: 14px;"><strong>' + (last3Months.length > 2 ? '‚ö†Ô∏è' : '‚úì') + ' Resumo:</strong> ';
                    html += last3Months.length + ' ida' + (last3Months.length !== 1 ? 's' : '') + ' √† urg√™ncia nos √∫ltimos 3 meses</p></div>';
                }
            } else if (tab === 'analises') {
                const labResults = cd.labResults || [];
                
                if (labResults.length === 0) {
                    html += '<div class="data-card"><p style="color: #666;">Sem an√°lises registadas</p></div>';
                } else {
                    labResults.slice().reverse().forEach(lab => {
                        const date = new Date(lab.date);
                        const dateStr = date.toLocaleDateString('pt-PT');
                        
                        html += '<div class="data-card">';
                        html += '<h4 style="color: #0ea5e9; margin-bottom: 12px;">üß™ ' + (lab.type || 'An√°lises') + ' - ' + dateStr + '</h4>';
                        html += '<p style="font-size: 14px; line-height: 1.8;">';
                        
                        if (lab.hemoglobin !== undefined) {
                            const hbColor = lab.hemoglobin < 6 ? '#dc2626' : lab.hemoglobin < 9 ? '#d97706' : '#059669';
                            const hbLabel = lab.hemoglobin < 6 ? ' (‚ö†Ô∏è Cr√≠tico)' : lab.hemoglobin < 9 ? ' (‚Üì)' : '';
                            html += '‚Ä¢ <strong>Hemoglobina:</strong> <span style="color: ' + hbColor + '; font-weight: bold;">' + 
                                   lab.hemoglobin + ' g/dL' + hbLabel + '</span><br>';
                        }
                        if (lab.hematocrit) html += '‚Ä¢ <strong>Hemat√≥crito:</strong> ' + lab.hematocrit + '%<br>';
                        if (lab.wbc) html += '‚Ä¢ <strong>Leuc√≥citos:</strong> ' + lab.wbc + '/ŒºL<br>';
                        if (lab.platelets) html += '‚Ä¢ <strong>Plaquetas:</strong> ' + lab.platelets + '/ŒºL<br>';
                        if (lab.reticulocytes) html += '‚Ä¢ <strong>Reticul√≥citos:</strong> ' + lab.reticulocytes + '%<br>';
                        if (lab.bilirubin) html += '‚Ä¢ <strong>Bilirrubina:</strong> ' + lab.bilirubin + ' mg/dL<br>';
                        if (lab.ldh) html += '‚Ä¢ <strong>LDH:</strong> ' + lab.ldh + ' U/L<br>';
                        if (lab.notes) html += '<br><strong>Obs:</strong> ' + lab.notes;
                        
                        html += '</p></div>';
                    });
                    
                    const hbResults = labResults.filter(l => l.hemoglobin).slice(-6);
                    if (hbResults.length >= 2) {
                        html += '<div class="section-title">üìà Evolu√ß√£o Hemoglobina</div><div class="data-card">';
                        hbResults.forEach(lab => {
                            const dateStr = new Date(lab.date).toLocaleDateString('pt-PT', {month: 'short', year: 'numeric'});
                            const width = Math.min((lab.hemoglobin / 15) * 100, 100);
                            const color = lab.hemoglobin < 6 ? '#dc2626' : lab.hemoglobin < 9 ? '#d97706' : '#059669';
                            html += '<div style="margin-bottom: 10px;"><div style="font-size: 12px; color: #666; margin-bottom: 3px;">' + dateStr + '</div>';
                            html += '<div style="background: #f3f4f6; border-radius: 6px; height: 24px;"><div style="background: ' + color + '; width: ' + width + '%; height: 100%; border-radius: 6px; display: flex; align-items: center; padding: 0 8px; color: white; font-weight: 600; font-size: 12px;">' + lab.hemoglobin + ' g/dL</div></div></div>';
                        });
                        html += '</div>';
                    }
                }
            } else if (tab === 'perfil') {
                // Informa√ß√µes b√°sicas
                html += '<div class="section-title">üë§ Informa√ß√£o Pessoal</div>';
                html += '<div class="info-card">';
                html += '<div class="info-row"><strong>Nome:</strong> ' + p.name + '</div>';
                html += '<div class="info-row"><strong>Idade:</strong> ' + calcAge(p.birthDate) + ' anos</div>';
                html += '<div class="info-row"><strong>G√©nero:</strong> ' + (p.gender === 'M' ? 'Masculino' : 'Feminino') + '</div>';
                html += '<div class="info-row"><strong>Email:</strong> ' + p.email + '</div>';
                html += '<div class="info-row"><strong>Telefone:</strong> ' + (p.phone || '<span style="color: #999;">N√£o dispon√≠vel</span>') + '</div>';
                html += '</div>';
                
                // Alergias Medicamentosas
                html += '<div class="section-title">‚ö†Ô∏è Alergias Medicamentosas</div>';
                if (p.medicationAllergies) {
                    html += '<div class="data-card alert">';
                    html += '<p style="font-size: 14px; line-height: 1.6; white-space: pre-wrap;">' + p.medicationAllergies + '</p>';
                    html += '</div>';
                } else {
                    html += '<div class="data-card">';
                    html += '<p style="color: #666; font-style: italic;">Sem alergias registadas</p>';
                    html += '</div>';
                }
                
                // Outras Doen√ßas
                html += '<div class="section-title">üè• Outras Doen√ßas / Condi√ß√µes</div>';
                if (p.otherDiseases) {
                    html += '<div class="data-card">';
                    html += '<p style="font-size: 14px; line-height: 1.6; white-space: pre-wrap;">' + p.otherDiseases + '</p>';
                    html += '</div>';
                } else {
                    html += '<div class="data-card">';
                    html += '<p style="color: #666; font-style: italic;">Sem outras doen√ßas registadas</p>';
                    html += '</div>';
                }
                
                // Informa√ß√µes de Transfus√£o
                html += '<div class="section-title">ü©∏ Informa√ß√£o sobre Transfus√µes</div>';
                const transfusionData = p.transfusionData || {};
                
                if (transfusionData.acceptsTransfusion) {
                    html += '<div class="info-card">';
                    
                    // Aceita transfus√µes
                    html += '<div class="info-row"><strong>Aceita transfus√µes:</strong> ';
                    if (transfusionData.acceptsTransfusion === 'sim') {
                        html += '<span style="color: #059669;">‚úì Sim</span>';
                    } else {
                        html += '<span style="color: #dc2626;">‚úó N√£o</span>';
                    }
                    html += '</div>';
                    
                    // Data da √∫ltima transfus√£o
                    if (transfusionData.lastTransfusionDate) {
                        const date = new Date(transfusionData.lastTransfusionDate);
                        const dateStr = date.toLocaleDateString('pt-PT', {day: '2-digit', month: 'long', year: 'numeric'});
                        html += '<div class="info-row"><strong>√öltima transfus√£o:</strong> ' + dateStr + '</div>';
                    }
                    
                    // Hist√≥ria de rea√ß√£o
                    html += '<div class="info-row"><strong>Hist√≥ria de rea√ß√£o:</strong> ';
                    if (transfusionData.hasReaction === 'sim') {
                        html += '<span style="color: #d97706;">‚ö†Ô∏è Sim</span>';
                        if (transfusionData.reactionDetails) {
                            html += '<br><span style="color: #666; font-size: 14px; margin-left: 20px; font-style: italic;">' + transfusionData.reactionDetails + '</span>';
                        }
                    } else if (transfusionData.hasReaction === 'nao') {
                        html += '<span style="color: #059669;">‚úì N√£o</span>';
                    } else {
                        html += '<span style="color: #999;">N√£o especificado</span>';
                    }
                    html += '</div>';
                    
                    // Medica√ß√£o pr√©-transfus√£o
                    html += '<div class="info-row"><strong>Medica√ß√£o pr√©-transfus√£o:</strong> ';
                    if (transfusionData.needsPreMedication === 'sim') {
                        html += '<span style="color: #0284c7;">Sim</span>';
                        if (transfusionData.preMedicationDetails) {
                            html += '<br><span style="color: #666; font-size: 14px; margin-left: 20px; font-style: italic;">' + transfusionData.preMedicationDetails + '</span>';
                        }
                    } else if (transfusionData.needsPreMedication === 'nao') {
                        html += 'N√£o';
                    } else {
                        html += '<span style="color: #999;">N√£o especificado</span>';
                    }
                    html += '</div>';
                    
                    // Hemoglobina basal
                    if (transfusionData.baselineHemoglobin) {
                        let hbColor = '#059669';
                        let hbNote = '';
                        if (transfusionData.baselineHemoglobin < 7) {
                            hbColor = '#dc2626';
                            hbNote = ' (Muito baixa)';
                        } else if (transfusionData.baselineHemoglobin < 9) {
                            hbColor = '#d97706';
                            hbNote = ' (Baixa)';
                        }
                        html += '<div class="info-row"><strong>Hemoglobina basal:</strong> ';
                        html += '<span style="color: ' + hbColor + '; font-weight: 600;">' + transfusionData.baselineHemoglobin + ' g/dL' + hbNote + '</span>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                } else {
                    html += '<div class="data-card">';
                    html += '<p style="color: #666; font-style: italic;">Sem informa√ß√µes de transfus√£o registadas</p>';
                    html += '</div>';
                }
            } else {
                html += '<div class="data-card"><p style="color: #666;">Sec√ß√£o n√£o dispon√≠vel</p></div>';
            }
            
            document.getElementById('patientContent').innerHTML = html;
            document.getElementById('patientModal').classList.add('show');
        }

        function closePatient() {
            document.getElementById('patientModal').classList.remove('show');
        }

        function doLogout() {
            if (confirm('Sair?')) {
                currentUser = null;
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
